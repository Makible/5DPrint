"use strict";var dbg=0,socket,statTimer,connTimer,deviceName,socketAddr="ws://";$(document).ready(function(){$("#init").show();socketAddr+=document.URL.substring(6)+"abs";
socket=new WebSocket(socketAddr);socket.onmessage=onMsg;socket.onclose=onClose;socket.onopen=function(){$("#status").html("connected");};attachBtnEvents();
connTimer=setInterval(checkConn,1000);});var manageDevConnection=function(a){if(a.DeviceName==""||a.DeviceName=="nil"){connTimer=setInterval(checkConn,1500);
return;}if(a.Body=="attached"){$("#init-msg").html("initializing device...");deviceName=a.DeviceName;$("#over-msg").fadeOut(100);$("#init").css("z-index","799").slideUp(1000,function(){$("#init").css("z-index","-1");
});if($("#status").html()!="connected"){$("#status").html("connected");}$("#device").html(deviceName);statTimer=setInterval(getStats,1500);return;}if(a.Body=="detached"){window.clearInterval(statTimer);
$("#device").html("device detached");$("#status").html("WARNING");$("#init-msg").html("waiting for device(s)...");$("#init").css("z-index","901").slideDown(1000,function(){$("#over-msg").fadeIn(100);
});connTimer=setInterval(checkConn,500);return;}};var attachBtnEvents=function(){$(".btn").each(function(){var a=this;$(a).on("click",function(b){if($(a).attr("id")!=undefined){var c=window[$(a).attr("id")];
if(typeof c==="function"){c();}else{if($(a).parent().attr("id")==="homer"){homer(a);}if($(a).parent().attr("id")==="controller"){mover(a);}}}else{if($(a).hasClass("set")){temper(a);
}else{if($(a).hasClass("off")){heatOff(a);}}}});});$("#init").on("click",function(a){if($(this).is(":visible")){checkConn();}});};var nav=function(){$("#menu").toggle();
if($("#menu").is(":visible")){$("#nav").addClass("nav-hover");$("#menu").find(".btn").each(function(){var a=this;$(a).off("click").on("click",function(b){menus(a);
$("#nav").click();});});}else{$("#nav").removeClass("nav-hover");}};var start=function(){if($("#file").html()!=""&&$("#status").html()=="loaded"){window.clearInterval(statTimer);
sendDevMsg("job","start");$("#status").html("printing");$("#init").css("z-index","799").css("cursor","auto").slideDown(1000,function(){$("#over-msg").fadeIn(200);
$("#over-msg > .init-msg").html("printing in progress");}).off("click");}else{var a=$('<input id="floader" type="file" accept=".gcode" class="fi" />');
$("body").append(a);$(a).on("change",function(b){var d=this.files[0],c=new FileReader();c.readAsText(d,"UTF-8");c.onload=shipFile;c.onloadstart=function(e){$("#status").html("loading");
};c.onloadend=function(e){$("#status").html("loaded");start();};$("#file").html(d.name);});$(a).click();}};var resume=function(){sendDevMsg("interrupt","resume");
$("#start").off("click");$("#start").on("click",start);};var pause=function(){sendDevMsg("interrupt","pause");$("#start").off("click");$("#start").on("click",resume);
};var mover=function(d){var f=$(d).attr("id").substring(0,1),b=($(d).hasClass("pos"))?"pos":"neg",e=(f=="x"||f=="y")?"xy":f,a=$("#"+e+"steps"),c=$("#"+e+"speed");
if(parseInt($(a).val())<parseInt($(a).attr("min"))||parseInt($(c).val())<parseInt($(c).attr("min"))){return;}var h=(parseInt($(a).val())>parseInt($(a).attr("max")))?$(a).attr("max"):$(a).val();
var g=(parseInt($(c).val())>parseInt($(c).attr("max")))?$(c).attr("max"):$(c).val();if(b=="neg"){h*=-1;}if(f=="e"){f+="1";}sendDevMsg("move",{Axis:f.toUpperCase(),Distance:parseInt(h),Speed:parseInt(g)});
};var homer=function(a){if($(a).attr("id")=="ho"){sendDevMsg("motley","motorsoff");}else{var b=$(a).html().toUpperCase();sendDevMsg("home",{Axis:b,Distance:0,Speed:0});
}};var temper=function(c){var a=$(c).parent().parent(),d=$(a).find("input");if(d!=undefined&&d!=null){if($(d).val().length>0){var b=(parseInt($(d).val())>parseInt($(d).attr("max")))?$(d).attr("max"):$(d).val();
sendDevMsg("temper",{Name:$(a).attr("id"),Value:parseInt(b)});}else{console.log("INSERT A VALID TEMPERATURE");}}else{console.log("[WARN] temper was not dispatched properly");
}};var menus=function(a){switch($(a).attr("id")){case"load":var b=$('<input id="floader" type="file" accept=".gcode" class="fi" />');$("body").append(b);
$(b).on("change",function(c){var e=this.files[0],d=new FileReader();d.readAsText(e,"UTF-8");d.onload=shipFile;d.onloadstart=function(f){$("#status").html("loading");
};d.onloadend=function(f){$("#status").html("loaded");};$("#file").html(e.name);});$(b).click();break;case"prefs":break;case"admin":break;case"exit":break;
default:break;}};var onMsg=function(a){if(dbg){console.log(a);}var b=JSON.parse(a.data);if(b.Type==="response"){switch(b.Action){case"job":if(b.Body=="complete"){$("#over-msg").fadeOut(100);
$("#init").css("z-index","799").slideUp(1000,function(){$("#init").css("z-index","-1");});$("#file").html("");statTimer=setInterval(getStats,1500);}break;
case"status":updateUIStatus(b);break;case"connection":manageDevConnection(b);break;case"console":console.log(b);break;case"error":console.log("[WARN] 5DPrint serv responded with error: "+b.Body);
if(b.Body.indexOf("invalid device name")>-1){b.Body="detached";manageDevConnection(b);}break;default:if(dbg){console.log(b);}break;}}};var onClose=function(a){window.clearInterval(statTimer);
$("#status").html("ws closed");connTimer=setInterval(checkConn,1000);console.log("[WARN] socket connection closed and stat timer killed");};var getStats=function(){sendDevMsg("status","");
};var checkConn=function(){sendCoreMsg("connection","");window.clearInterval(connTimer);};var updateUIStatus=function(a){var b,j=a.Body.split("\n");for(var d=0;
d<j.length;d++){if(j[d].indexOf("T:")>-1){var e=j[d],h=0;if(e.indexOf("ok")!=-1){h=1;}var c=e.split(" ")[h],f=e.split(" ")[h+2],g='<span class="deg">&deg;C</span>';
if(c==undefined||f==undefined){return;}b=c.substring(2,c.length);$("#hotend").find(".actual").html(b+g);b=f.substring(2,f.length);$("#hotbed").find(".actual").html(b+g);
if(dbg){console.log("[DBG] RAW: "+e);}}}};var sendCoreMsg=function(d,c){var a=(c.length>0)?JSON.stringify(c):c;var e=JSON.stringify({Type:"core",DeviceName:"",Action:d,Body:a});
socket.send(e);};var sendDevMsg=function(b,a){var c=JSON.stringify({Type:"device",DeviceName:deviceName,Action:b,Body:JSON.stringify(a)});socket.send(c);
};var sendConsoleMsg=function(a){sendDevMsg("console",a);};var shipFile=function(a){var c="load",d=document.getElementById("floader").files[0].name,b=a.target.result;
sendDevMsg(c,{Name:d,Data:b});$("#floader").remove();};var showDbg=function(){dbg=!0;};var hideDbg=function(){dbg=0;};var fakeDevice=function(){window.clearInterval(connTimer);
manageDevConnection({Device:"foo",Body:"attached"});window.clearInterval(statTimer);};